name: Package - Beta (Create Version + PR)

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: "e.g. 0.1.0.4"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: package-beta
  cancel-in-progress: false

jobs:
  beta:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SF CLI + jq
        shell: bash
        run: |
          set -euo pipefail
          npm install --global @salesforce/cli
          sf --version
          sf plugins --core
          sf plugins install @salesforce/plugin-packaging
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Authenticate Dev Hub
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" > devhub_auth_url.txt
          sf org login sfdx-url --sfdx-url-file devhub_auth_url.txt --alias DevHub --set-default-dev-hub
          rm -f devhub_auth_url.txt
          sf org display --target-org DevHub --verbose || true

      - name: Create package version (not promoted)
        id: create
        shell: bash
        run: |
          set -euo pipefail

          set +e
          sf package version create \
            --target-dev-hub DevHub \
            --package "testPackage" \
            --installation-key-bypass \
            --version-number "${{ inputs.version_number }}" \
            --code-coverage \
            --wait 60 \
            --json > create.json
          SF_EXIT=$?
          set -e

          echo "=== sf exit code: $SF_EXIT ==="
          echo "=== create.json ==="
          cat create.json
          echo "==================="

          STATUS=$(jq -r '.status // empty' create.json)
          if [ "$SF_EXIT" -ne 0 ] || [ "$STATUS" = "1" ]; then
            echo "sf failed to create package version."
            jq -r '.name // empty' create.json || true
            jq -r '.message // empty' create.json || true
            exit 1
          fi

          VERSION_ID=$(jq -r '.result.SubscriberPackageVersionId // empty' create.json)
          if [ -z "$VERSION_ID" ]; then
            echo "Could not find SubscriberPackageVersionId in create.json"
            exit 1
          fi

          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"
          echo "Created version: $VERSION_ID"

      - name: Update sfdx-project.json (packageAliases)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version_number }}"
          VERSION_ID="${{ steps.create.outputs.version_id }}"

          TMP=$(mktemp)
          jq --arg k "testPackage@$VERSION" --arg v "$VERSION_ID" \
            '.packageAliases[$k] = $v' sfdx-project.json > "$TMP"
          mv "$TMP" sfdx-project.json

      - name: Create branch + commit
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version_number }}"
          BRANCH="beta/${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add sfdx-project.json
          git commit -m "Beta: testPackage $VERSION"
          git push origin "$BRANCH"

      - name: Create PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version_number }}"
          BRANCH="beta/${VERSION}"

          gh pr create \
            --title "Beta testPackage $VERSION" \
            --body "Automated beta PR. Created package version (NOT promoted): ${{ steps.create.outputs.version_id }}" \
            --base main \
            --head "$BRANCH"
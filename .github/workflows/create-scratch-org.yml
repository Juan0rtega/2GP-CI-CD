name: Scratch - On demand (create admin user + password reset)

on:
  workflow_dispatch:
    inputs:
      email:
        description: "Email for the new admin user"
        required: true
        type: string
      first_name:
        description: "First name for the new admin user"
        required: true
        type: string
      last_name:
        description: "Last name for the new admin user"
        required: true
        type: string
      days:
        description: "Scratch org duration in days"
        required: true
        default: "3"
        type: string
      alias:
        description: "Scratch org alias (optional)"
        required: false
        default: ""
        type: string

permissions:
  contents: read

concurrency:
  group: scratch-on-demand
  cancel-in-progress: false

jobs:
  create:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install SF CLI + jq
        shell: bash
        run: |
          set -euo pipefail
          npm install --global @salesforce/cli
          sf --version
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Authenticate Dev Hub
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" > devhub_auth_url.txt
          sf org login sfdx-url --sfdx-url-file devhub_auth_url.txt --alias DevHub --set-default-dev-hub
          rm -f devhub_auth_url.txt

      - name: Resolve scratch alias
        id: alias
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.alias }}" ]; then
            echo "value=${{ inputs.alias }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=scratch-${{ github.run_id }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create scratch org
        shell: bash
        run: |
          set -euo pipefail
          ALIAS="${{ steps.alias.outputs.value }}"

          sf org create scratch \
            --target-dev-hub DevHub \
            --definition-file config/project-scratch-def.json \
            --alias "$ALIAS" \
            --duration-days "${{ inputs.days }}" \
            --set-default \
            --wait 20

          sf org display --target-org "$ALIAS" --verbose

      - name: Deploy metadata (optional)
        shell: bash
        run: |
          set -euo pipefail
          ALIAS="${{ steps.alias.outputs.value }}"
          sf project deploy start --target-org "$ALIAS" --wait 30

      - name: Create new System Admin user
        id: newuser
        shell: bash
        run: |
          set -euo pipefail
          ALIAS="${{ steps.alias.outputs.value }}"
          EMAIL="${{ inputs.email }}"
          FIRST="${{ inputs.first_name }}"
          LAST="${{ inputs.last_name }}"

          # Build a globally-unique username based on the provided email
          LOCAL="${EMAIL%@*}"
          DOMAIN="${EMAIL#*@}"
          if [ "$LOCAL" = "$EMAIL" ] || [ "$DOMAIN" = "$EMAIL" ]; then
            echo "Input email must contain '@': $EMAIL"
            exit 1
          fi
          USERNAME="${LOCAL}+gh${{ github.run_id }}@${DOMAIN}"

          # Get System Administrator profile Id
          PROFILE_ID=$(sf data query \
            --target-org "$ALIAS" \
            --query "SELECT Id FROM Profile WHERE Name = 'System Administrator' LIMIT 1" \
            --json | jq -r '.result.records[0].Id // empty')

          if [ -z "$PROFILE_ID" ]; then
            echo "Could not find System Administrator profile Id"
            exit 1
          fi

          # Generate alias (<= 8 chars, alphanumeric)
          ALIAS2=$(echo "${FIRST:0:1}${LAST:0:4}" | tr -cd '[:alnum:]' | tr '[:upper:]' '[:lower:]')
          if [ -z "$ALIAS2" ]; then ALIAS2="admin"; fi

          OUT=$(sf data create record \
            --target-org "$ALIAS" \
            --sobject User \
            --values "FirstName='${FIRST}' LastName='${LAST}' Email='${EMAIL}' Username='${USERNAME}' Alias='${ALIAS2}' TimeZoneSidKey='America/Mexico_City' LocaleSidKey='es_MX' EmailEncodingKey='UTF-8' LanguageLocaleKey='es_MX' ProfileId='${PROFILE_ID}'" \
            --json)

          echo "$OUT" | jq -r .
          USER_ID=$(echo "$OUT" | jq -r '.result.id // empty')
          if [ -z "$USER_ID" ]; then
            echo "Could not parse new user id"
            exit 1
          fi

          echo "user_id=$USER_ID" >> "$GITHUB_OUTPUT"
          echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
          echo "Created new admin user: $USERNAME ($USER_ID)"

      - name: Send password reset email to new admin user
        shell: bash
        run: |
          set -euo pipefail
          ALIAS="${{ steps.alias.outputs.value }}"
          USER_ID="${{ steps.newuser.outputs.user_id }}"

          cat > reset_password.apex <<APEX
          System.resetPassword('${USER_ID}', true);
          APEX

          sf apex run --target-org "$ALIAS" --file reset_password.apex
          rm -f reset_password.apex

      - name: Output next steps
        shell: bash
        run: |
          set -euo pipefail
          echo "Scratch alias: ${{ steps.alias.outputs.value }}"
          echo "New admin username: ${{ steps.newuser.outputs.username }}"
          echo "Password reset email sent (if Deliverability allows emails)."